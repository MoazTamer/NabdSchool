@{
    ViewData["Page"] = "تقرير بالتأخر اليومي";
}

<style>
    label {
        font-size: 1.2rem;
        font-weight: bold;
    }

    tbody {
        font-size: 1.1rem;
        font-weight: 600;
    }

    .excel-btn {
        background-color: #198754 !important;
        color: white !important;
        border: none !important;
        padding: 9px 18px !important;
    }

    .dt-buttons .btn {
        border-radius: 5px !important;
    }

    .form-control.form-control-solid {
        font-size: 1.2rem;
        font-weight: bold;
        color: black;
    }

    table.dataTable.table-striped > tbody > tr:nth-of-type(2n+1) > * {
        box-shadow: none !important;
        background: white !important;
    }

</style>
<!--begin::Content wrapper-->
<div class="d-flex flex-column flex-column-fluid">
    <!--begin::Toolbar-->
    <div id="kt_app_toolbar" class="app-toolbar pt-7 pt-lg-10">
        <div id="kt_app_toolbar_container" class="app-container container-fluid d-flex align-items-stretch">
            <div class="app-toolbar-wrapper d-flex flex-stack flex-wrap gap-4 w-100">
                <div class="page-title d-flex align-items-center gap-1 me-3">
                    <div class="symbol symbol-60px me-3">
                        <img src="~/images/school-logo.png" alt="شعار المدرسة" />
                    </div>
                    <div class="d-flex flex-column justify-content-center">
                        <h1 class="page-heading d-flex align-items-center text-dark fw-bold fs-3 m-0">
                            <i class="ki-outline ki-information-3 fs-1 me-3 text-danger"></i>
                            @ViewData["Page"]
                        </h1>
                        <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 pt-1 mb-0">
                            <li class="breadcrumb-item text-muted">الرئيسية</li>
                            <li class="breadcrumb-item"><span class="bullet bg-gray-400 w-5px h-2px"></span></li>
                            <li class="breadcrumb-item text-muted">التقارير</li>
                            <li class="breadcrumb-item"><span class="bullet bg-gray-400 w-5px h-2px"></span></li>
                            <li class="breadcrumb-item text-muted">التأخر اليومي</li>
                        </ul>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2 gap-lg-3">
                    <a href="@Url.Action("Index", "Home")" class="btn btn-sm btn-light-primary">
                        <i class="ki-outline ki-arrow-right fs-2"></i>
                        رجوع
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!--end::Toolbar-->
    <!--begin::Content-->
    <div id="kt_app_content" class="app-content flex-column-fluid">
        <div id="kt_app_content_container" class="app-container container-fluid">

            <!--begin::Filter Card-->
            <div class="card shadow-sm mb-5">
                <div class="card-header border-0 pt-6">
                    <div class="card-title">
                        <i class="ki-outline ki-filter fs-2x text-primary me-3"></i>
                        <h3 class="fw-bold m-0">تصفية التقرير</h3>
                    </div>
                </div>
                <div class="card-body pt-0">
                    <div class="row g-5">
                        <!--begin::Date-->
                        <div class="col-md-3">
                            <label class="form-label fw-bold">التاريخ</label>
                            <input type="date" id="reportDate" class="form-control form-control-solid" />
                        </div>
                        <!--end::Date-->
                        <!--begin::Class-->
                        <div class="col-md-3">
                            <label class="form-label fw-bold">الصف</label>
                            <select id="classFilter" class="form-select form-select-solid">
                                <option value="">جميع الصفوف</option>
                            </select>
                        </div>
                        <!--end::Class-->
                        <!--begin::ClassRoom-->
                        <div class="col-md-3">
                            <label class="form-label fw-bold">الفصل</label>
                            <select id="classRoomFilter" class="form-select form-select-solid" disabled>
                                <option value="">جميع الفصول</option>
                            </select>
                        </div>
                        <!--end::ClassRoom-->
                        <!--begin::Actions-->
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="button" id="btnSearch" class="btn btn-primary w-100">
                                <i class="ki-outline ki-magnifier fs-2"></i>
                                عرض التقرير
                            </button>
                        </div>
                        <!--end::Actions-->
                    </div>
                </div>
            </div>
            <!--end::Filter Card-->
            <!--begin::Summary Cards-->
            <div class="row g-5 mb-5" id="summaryCards" style="display: none;">
                <div class="col-md-4">
                    <div class="card card-flush bg-light-danger h-100">
                        <div class="card-body">
                            <i class="ki-outline ki-information-3 fs-3hx text-danger mb-3"></i>
                            <div>
                                <span class="text-gray-700 fw-bold fs-6 d-block">إجمالي الطلاب المتأخرين</span>
                                <span class="text-danger fw-bold fs-2x" id="totalAbsent">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-flush bg-light-warning h-100">
                        <div class="card-body">
                            <i class="ki-outline ki-chart-simple fs-3hx text-warning mb-3"></i>
                            <div>
                                <span class="text-gray-700 fw-bold fs-6 d-block">عدد الفصول المتأثرة</span>
                                <span class="text-warning fw-bold fs-2x" id="totalClasses">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-flush bg-light-info h-100">
                        <div class="card-body">
                            <i class="ki-outline ki-calendar fs-3hx text-info mb-3"></i>
                            <div>
                                <span class="text-gray-700 fw-bold fs-6 d-block">تاريخ التقرير</span>
                                <span class="text-info fw-bold fs-4" id="reportDateDisplay">--/--/----</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--end::Summary Cards-->
            <!--begin::DataTable Card-->
            <div class="card shadow-sm" id="tableCard" style="display: none;">
                <div class="card-header border-0 pt-6">
                    <div class="card-title">
                        <i class="ki-outline ki-document fs-2x text-primary me-3"></i>
                        <h3 class="fw-bold m-0">تفاصيل التأخر</h3>
                    </div>
                    <div class="card-toolbar">
                        <button type="button" id="btnPrintPdf" class="btn btn-sm btn-primary me-2">
                            <i class="ki-outline ki-printer fs-2"></i>
                            طباعة PDF
                        </button>
                    </div>
                </div>
                <div class="card-body pt-0">
                    <table id="dailyLateTable" class="table table-striped table-row-bordered gy-5 gs-7">
                        <thead>
                            <tr class="fw-bold fs-6 text-light">
                                <th class="text-center">م</th>
                                <th>اسم الطالبة</th>
                                <th class="text-center">كود الطالبة</th>
                                <th>الصف</th>
                                <th>الفصل</th>
                                <th class="text-center">رقم الجوال</th>
                                <th class="text-center">وقت الحضور</th>
                                <th class="text-center">الأيام المتأخرة المتتالية</th>
                                <th>ملاحظات</th>
                            </tr>
                        </thead>
                        <tbody class="fw-bold fs-6"></tbody>
                    </table>
                </div>
            </div>
            <!--end::DataTable Card-->
            <!--begin::Empty State-->
            <div class="card shadow-sm" id="emptyState">
                <div class="card-body text-center py-20">
                    <i class="ki-outline ki-file-deleted fs-5x text-gray-400 mb-5"></i>
                    <h3 class="text-gray-600 fw-bold mb-3">لا توجد بيانات</h3>
                    <p class="text-gray-500">اختر التاريخ والفلاتر ثم اضغط على "عرض التقرير"</p>
                </div>
            </div>
            <!--end::Empty State-->

        </div>
    </div>
    <!--end::Content-->
</div>
<!--end::Content wrapper-->
@section Styles
{
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
}

@section Scripts
{
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

    <!-- DataTables Buttons -->
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

    <script>
        var datatable;
        var tableData = [];

        $(document).ready(function() {
            // Set today's date as default
            $('#reportDate').val(new Date().toISOString().split('T')[0]);

            // Initialize DataTable
            initTable();

            // Load classes
            loadClasses();

            // Class change event
            $('#classFilter').change(function() {
                const classId = $(this).val();
                if (classId) {
                    loadClassRooms(classId);
                    $('#classRoomFilter').prop('disabled', false);
                } else {
                    $('#classRoomFilter').html('<option value="">جميع الفصول</option>').prop('disabled', true);
                }
            });

            // Search button
            $('#btnSearch').click(function() {
                loadReport();
            });

            // Print PDF button
            $('#btnPrintPdf').click(function() {
                printOfficialReport();
            });
        });

        // Initialize DataTable
        var initTable = function () {
            datatable = $('#dailyLateTable').DataTable({
                responsive: true,
                processing: true,
                serverSide: false,
                data: [],
                dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                     "<'row'<'col-sm-12'tr>>" +
                     "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
                buttons: [
                    {
                        extend: 'excelHtml5',
                        text: '<i class="fas fa-file-excel"></i> Excel',
                        className: 'btn btn-success me-1 excel-btn',
                        title: 'تقرير التأخر اليومي',
                        filename: function () {
                            const date = $('#reportDate').val();
                            return 'تقرير_التأخر_اليومي_' + date;
                        },
                        exportOptions: {
                            columns: ':visible'
                        }
                    }
                ],
                language: {
                    search: "البحث:",
                    emptyTable: "لا توجد بيانات",
                    loadingRecords: "جارى التحميل ...",
                    processing: "جارى التحميل ...",
                    lengthMenu: "عرض _MENU_",
                    paginate: {
                        first: "الأول",
                        last: "الأخير",
                        next: "التالى",
                        previous: "السابق"
                    },
                    info: "عرض _START_ الى _END_ من _TOTAL_ مدخل",
                    infoFiltered: "(البحث من _MAX_ إجمالى المدخلات)",
                    infoEmpty: "لا توجد مدخلات للعرض",
                    zeroRecords: "لا توجد مدخلات مطابقة للبحث"
                },
                pageLength: 10,
                order: [[0, "asc"]],
                columns: [
                    {
                        data: null,
                        className: 'text-center',
                        render: function (data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    {
                        data: 'studentName',
                        render: function(data) {
                            return data || '-';
                        }
                    },
                    {
                        data: 'studentCode',
                        className: 'text-center',
                        render: function(data) {
                            return data || '-';
                        }
                    },
                    {
                        data: 'className',
                        render: function(data) {
                            return data || '-';
                        }
                    },
                    {
                        data: 'classRoomName',
                        render: function(data) {
                            return data || '-';
                        }
                    },
                    {
                        data: 'studentPhone',
                        className: 'text-center',
                        render: function(data) {
                            return data || '-';
                        }
                    },
                    {
                        data: 'attendanceTime',
                        className: 'text-center',
                        render: function(data) {
                            if (!data) return '-';
                            // تحويل TimeSpan إلى تنسيق الوقت
                            const timeParts = data.split(':');
                            if (timeParts.length >= 2) {
                                const timeStr = timeParts[0] + ':' + timeParts[1];
                                return `<span class="badge badge-light-primary fw-bold">${timeStr}</span>`;
                            }
                            return '-';
                        }
                    },
                    {
                        data: 'consecutiveAbsenceDays',
                        className: 'text-center',
                        render: function(data) {
                            const badgeClass = data >= 3 ? 'badge-danger' : 'badge-warning';
                            return `<span class="badge ${badgeClass}">${data} يوم</span>`;
                        }
                    },
                    {
                        data: 'notes',
                        className: 'text-center',
                        render: function(data) {
                            return data || '-';
                        }
                    }
                ],
                rowCallback: function(row, data) {
                    if (data.consecutiveAbsenceDays >= 3) {
                        $(row).addClass('bg-light-danger');
                    }
                }
            });

            // Add Excel button to toolbar
            datatable.buttons().container().appendTo($('#tableCard .card-toolbar'));
        };

        // Load classes dropdown
        function loadClasses() {
            $.get('@Url.Action("GetClasses", "Reports")', function(response) {
                if (response.success) {
                    const select = $('#classFilter');
                    response.data.forEach(function(item) {
                        select.append(`<option value="${item.id}">${item.name}</option>`);
                    });
                }
            });
        }

        // Load classrooms dropdown
        function loadClassRooms(classId) {
            $.get('@Url.Action("GetClassRooms", "Reports")', { classId: classId }, function(response) {
                const select = $('#classRoomFilter');
                select.html('<option value="">جميع الفصول</option>');

                if (response.success) {
                    response.data.forEach(function(item) {
                        select.append(`<option value="${item.id}">${item.name}</option>`);
                    });
                }
            });
        }

        // Load report
        function loadReport() {
            const date = $('#reportDate').val();
            const classId = $('#classFilter').val() || null;
            const classRoomId = $('#classRoomFilter').val() || null;

            if (!date) {
                Swal.fire('تنبيه', 'الرجاء اختيار التاريخ', 'warning');
                return;
            }

            // Show loading
            Swal.fire({
                title: 'جاري تحميل التقرير...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            $.get('@Url.Action("GetDailyLateReport", "Reports")', {
                date: date,
                classId: classId,
                classRoomId: classRoomId
            }, function(response) {
                Swal.close();

                if (response.success) {
                    displayReport(response.data);
                } else {
                    Swal.fire('خطأ', response.message, 'error');
                }
            }).fail(function() {
                Swal.close();
                Swal.fire('خطأ', 'حدث خطأ أثناء تحميل التقرير', 'error');
            });
        }

        // Display report
        function displayReport(data) {
            if (!data.classesAbsence || data.classesAbsence.length === 0) {
                $('#emptyState').show();
                $('#tableCard').hide();
                $('#summaryCards').hide();

                // Clear DataTable
                datatable.clear().draw();

                Swal.fire('معلومة', 'لا يوجد طلاب متأخرين في هذا اليوم! 🎉', 'info');
                return;
            }

            // Update summary
            $('#totalAbsent').text(data.totalAbsentStudents);
            $('#totalClasses').text(data.totalClasses);
            $('#reportDateDisplay').text(new Date(data.reportDate).toLocaleDateString('ar-EG'));

            // Prepare data for DataTable
            tableData = [];
            data.classesAbsence.forEach(function(classData) {
                classData.absentStudentsList.forEach(function(student) {
                    tableData.push({
                        studentName: student.studentName,
                        studentCode: student.studentCode,
                        className: classData.className,
                        classRoomName: classData.classRoomName,
                        studentPhone: student.studentPhone,
                        attendanceTime: student.attendanceTime,
                        consecutiveAbsenceDays: student.consecutiveAbsenceDays,
                        notes: student.notes
                    });
                });
            });

            // Update DataTable
            datatable.clear().rows.add(tableData).draw();

            // Show report
            $('#emptyState').hide();
            $('#tableCard').show();
            $('#summaryCards').show();
        }

        // Print Official PDF Report
        function printOfficialReport() {
            const date = $('#reportDate').val();
            const classId = $('#classFilter').val() || '';
            const classRoomId = $('#classRoomFilter').val() || '';

            if (!date) {
                Swal.fire('تنبيه', 'الرجاء اختيار التاريخ', 'warning');
                return;
            }

            // Show loading
            Swal.fire({
                title: 'جاري إنشاء التقرير...',
                text: 'الرجاء الانتظار',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '@Url.Action("PrintDailyLatePdf", "Reports")', true);
            xhr.responseType = 'blob';
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

            xhr.onload = function() {
                Swal.close();

                if (xhr.status === 200) {
                    const contentType = xhr.getResponseHeader('content-type');

                    if (contentType && contentType.includes('application/json')) {
                        const reader = new FileReader();
                        reader.onload = function() {
                            try {
                                const error = JSON.parse(reader.result);
                                Swal.fire('خطأ', error.message || 'حدث خطأ أثناء إنشاء التقرير', 'error');
                            } catch(e) {
                                Swal.fire('خطأ', 'حدث خطأ أثناء إنشاء التقرير', 'error');
                            }
                        };
                        reader.readAsText(xhr.response);
                    } else {
                        const blob = xhr.response;
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `تقرير_التأخر_اليومي_${date}.pdf`;
                        document.body.appendChild(a);
                        a.click();

                        setTimeout(() => {
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                        }, 100);

                        Swal.fire({
                            icon: 'success',
                            title: 'تم!',
                            text: 'تم إنشاء التقرير بنجاح',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    }
                } else {
                    Swal.fire('خطأ', 'حدث خطأ أثناء إنشاء التقرير: ' + xhr.statusText, 'error');
                }
            };

            xhr.onerror = function() {
                Swal.close();
                Swal.fire('خطأ', 'حدث خطأ في الاتصال بالسيرفر', 'error');
            };

            const formData = `date=${encodeURIComponent(date)}&classId=${classId}&classRoomId=${classRoomId}`;
            xhr.send(formData);
        }
    </script>
}