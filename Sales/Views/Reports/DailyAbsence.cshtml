@{
    ViewData["Page"] = "تقرير الغياب اليومي";
}

<!--begin::Content wrapper-->
<div class="d-flex flex-column flex-column-fluid">
    <!--begin::Toolbar-->
    <div id="kt_app_toolbar" class="app-toolbar pt-7 pt-lg-10">
        <div id="kt_app_toolbar_container" class="app-container container-fluid d-flex align-items-stretch">
            <div class="app-toolbar-wrapper d-flex flex-stack flex-wrap gap-4 w-100">
                <div class="page-title d-flex align-items-center gap-1 me-3">
                    <div class="symbol symbol-60px me-3">
                        <img src="~/images/school-logo.png" alt="شعار المدرسة" />
                    </div>
                    <div class="d-flex flex-column justify-content-center">
                        <h1 class="page-heading d-flex align-items-center text-dark fw-bold fs-3 m-0">
                            <i class="ki-outline ki-information-3 fs-1 me-3 text-danger"></i>
                            @ViewData["Page"]
                        </h1>
                        <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 pt-1 mb-0">
                            <li class="breadcrumb-item text-muted">الرئيسية</li>
                            <li class="breadcrumb-item"><span class="bullet bg-gray-400 w-5px h-2px"></span></li>
                            <li class="breadcrumb-item text-muted">التقارير</li>
                            <li class="breadcrumb-item"><span class="bullet bg-gray-400 w-5px h-2px"></span></li>
                            <li class="breadcrumb-item text-muted">الغياب اليومي</li>
                        </ul>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2 gap-lg-3">
                    <a href="@Url.Action("Index", "Home")" class="btn btn-sm btn-light-primary">
                        <i class="ki-outline ki-arrow-right fs-2"></i>
                        رجوع
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!--end::Toolbar-->

    <!--begin::Content-->
    <div id="kt_app_content" class="app-content flex-column-fluid">
        <div id="kt_app_content_container" class="app-container container-fluid">

            <!--begin::Filter Card-->
            <div class="card shadow-sm mb-5">
                <div class="card-header border-0 pt-6">
                    <div class="card-title">
                        <i class="ki-outline ki-filter fs-2x text-primary me-3"></i>
                        <h3 class="fw-bold m-0">تصفية التقرير</h3>
                    </div>
                </div>
                <div class="card-body pt-0">
                    <div class="row g-5">
                        <!--begin::Date-->
                        <div class="col-md-3">
                            <label class="form-label fw-bold">التاريخ</label>
                            <input type="date" id="reportDate" class="form-control form-control-solid" />
                        </div>
                        <!--end::Date-->

                        <!--begin::Class-->
                        <div class="col-md-3">
                            <label class="form-label fw-bold">الصف</label>
                            <select id="classFilter" class="form-select form-select-solid">
                                <option value="">جميع الصفوف</option>
                            </select>
                        </div>
                        <!--end::Class-->

                        <!--begin::ClassRoom-->
                        <div class="col-md-3">
                            <label class="form-label fw-bold">الفصل</label>
                            <select id="classRoomFilter" class="form-select form-select-solid" disabled>
                                <option value="">جميع الفصول</option>
                            </select>
                        </div>
                        <!--end::ClassRoom-->

                        <!--begin::Actions-->
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="button" id="btnSearch" class="btn btn-primary w-100">
                                <i class="ki-outline ki-magnifier fs-2"></i>
                                عرض التقرير
                            </button>
                        </div>
                        <!--end::Actions-->
                    </div>
                </div>
            </div>
            <!--end::Filter Card-->

            <!--begin::Summary Cards-->
            <div class="row g-5 mb-5" id="summaryCards" style="display: none;">
                <div class="col-md-4">
                    <div class="card card-flush bg-light-danger h-100">
                        <div class="card-body">
                            <i class="ki-outline ki-information-3 fs-3hx text-danger mb-3"></i>
                            <div>
                                <span class="text-gray-700 fw-bold fs-6 d-block">إجمالي الطلاب الغائبين</span>
                                <span class="text-danger fw-bold fs-2x" id="totalAbsent">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-flush bg-light-warning h-100">
                        <div class="card-body">
                            <i class="ki-outline ki-chart-simple fs-3hx text-warning mb-3"></i>
                            <div>
                                <span class="text-gray-700 fw-bold fs-6 d-block">عدد الفصول المتأثرة</span>
                                <span class="text-warning fw-bold fs-2x" id="totalClasses">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-flush bg-light-info h-100">
                        <div class="card-body">
                            <i class="ki-outline ki-calendar fs-3hx text-info mb-3"></i>
                            <div>
                                <span class="text-gray-700 fw-bold fs-6 d-block">تاريخ التقرير</span>
                                <span class="text-info fw-bold fs-4" id="reportDateDisplay">--/--/----</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--end::Summary Cards-->

            <!--begin::Report Container-->
            <div id="reportContainer" style="display: none;">
                <div id="classesContainer"></div>
            </div>
            <!--end::Report Container-->

            <!--begin::Empty State-->
            <div class="card shadow-sm" id="emptyState">
                <div class="card-body text-center py-20">
                    <i class="ki-outline ki-file-deleted fs-5x text-gray-400 mb-5"></i>
                    <h3 class="text-gray-600 fw-bold mb-3">لا توجد بيانات</h3>
                    <p class="text-gray-500">اختر التاريخ والفلاتر ثم اضغط على "عرض التقرير"</p>
                </div>
            </div>
            <!--end::Empty State-->

            <!--begin::Export Buttons-->
            <div class="d-flex justify-content-end gap-3 mt-5" id="exportButtons" style="display: none !important;">
                <button type="button" id="btnPrintPdf" class="btn btn-primary">
                    <i class="ki-outline ki-printer fs-2"></i>
                    طباعة تقرير (PDF)
                </button>
                <button type="button" id="btnPrint" class="btn btn-light-primary">
                    <i class="ki-outline ki-document fs-2"></i>
                    معاينة سريعة
                </button>

                @* <button type="button" id="btnExportExcel" class="btn btn-light-success">
                    <i class="ki-outline ki-file-down fs-2"></i>
                    تصدير Excel
                </button> *@
            </div>
            <!--end::Export Buttons-->

        </div>
    </div>
    <!--end::Content-->
</div>
<!--end::Content wrapper-->

@section Scripts
{
    <script>
        $(document).ready(function() {
            // Set today's date as default
            $('#reportDate').val(new Date().toISOString().split('T')[0]);

            // Load classes
            loadClasses();

            // Class change event
            $('#classFilter').change(function() {
                const classId = $(this).val();
                if (classId) {
                    loadClassRooms(classId);
                    $('#classRoomFilter').prop('disabled', false);
                } else {
                    $('#classRoomFilter').html('<option value="">جميع الفصول</option>').prop('disabled', true);
                }
            });

            // Search button
            $('#btnSearch').click(function() {
                loadReport();
            });

            // Print button
            $('#btnPrint').click(function() {
                window.print();
            });

            // Print PDF button - التقرير الرسمي
            $('#btnPrintPdf').click(function() {
                printOfficialReport();
            });

            // Export Excel button
            $('#btnExportExcel').click(function() {
                exportToExcel();
            });
        });

        // Load classes dropdown
        function loadClasses() {
            $.get('@Url.Action("GetClasses", "Reports")', function(response) {
                if (response.success) {
                    const select = $('#classFilter');
                    response.data.forEach(function(item) {
                        select.append(`<option value="${item.id}">${item.name}</option>`);
                    });
                }
            });
        }

        // Load classrooms dropdown
        function loadClassRooms(classId) {
            $.get('@Url.Action("GetClassRooms", "Reports")', { classId: classId }, function(response) {
                const select = $('#classRoomFilter');
                select.html('<option value="">جميع الفصول</option>');
                
                if (response.success) {
                    response.data.forEach(function(item) {
                        select.append(`<option value="${item.id}">${item.name}</option>`);
                    });
                }
            });
        }

        // Load report
        function loadReport() {
            const date = $('#reportDate').val();
            const classId = $('#classFilter').val() || null;
            const classRoomId = $('#classRoomFilter').val() || null;

            if (!date) {
                Swal.fire('تنبيه', 'الرجاء اختيار التاريخ', 'warning');
                return;
            }

            // Show loading
            Swal.fire({
                title: 'جاري تحميل التقرير...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            $.get('@Url.Action("GetDailyAbsenceReport", "Reports")', {
                date: date,
                classId: classId,
                classRoomId: classRoomId
            }, function(response) {
                Swal.close();

                if (response.success) {
                    displayReport(response.data);
                } else {
                    Swal.fire('خطأ', response.message, 'error');
                }
            }).fail(function() {
                Swal.close();
                Swal.fire('خطأ', 'حدث خطأ أثناء تحميل التقرير', 'error');
            });
        }

        // Display report
        function displayReport(data) {
            if (!data.classesAbsence || data.classesAbsence.length === 0) {
                $('#emptyState').show();
                $('#reportContainer').hide();
                $('#summaryCards').hide();
                $('#exportButtons').hide();
                
                Swal.fire('معلومة', 'لا يوجد طلاب غائبين في هذا اليوم! 🎉', 'info');
                return;
            }

            // Update summary
            $('#totalAbsent').text(data.totalAbsentStudents);
            $('#totalClasses').text(data.totalClasses);
            $('#reportDateDisplay').text(new Date(data.reportDate).toLocaleDateString('ar-EG'));

            // Build classes cards
            let html = '';
            data.classesAbsence.forEach(function(classData) {
                html += buildClassCard(classData);
            });

            $('#classesContainer').html(html);
            
            // Show report
            $('#emptyState').hide();
            $('#reportContainer').show();
            $('#summaryCards').show();
            $('#exportButtons').show();
        }

        // Build class card HTML
        function buildClassCard(classData) {
            let studentsRows = '';
            classData.absentStudentsList.forEach(function(student, index) {
                const warningClass = student.consecutiveAbsenceDays >= 3 ? 'bg-light-danger' : '';
                studentsRows += `
                    <tr class="${warningClass}">
                        <td class="text-center">${index + 1}</td>
                        <td>${student.studentName}</td>
                        <td class="text-center">${student.studentCode || '-'}</td>
                        <td class="text-center">${student.studentPhone || '-'}</td>
                        <td class="text-center">
                            <span class="badge badge-danger">${student.consecutiveAbsenceDays} يوم</span>
                        </td>
                        <td>${student.notes || '-'}</td>
                    </tr>
                `;
            });

            return `
                <div class="card shadow-sm mb-5">
                    <div class="card-header bg-light-primary">
                        <div class="card-title">
                            <h3 class="fw-bold text-gray-800">
                                <i class="ki-outline ki-element-11 fs-2 text-primary me-2"></i>
                                ${classData.className} - ${classData.classRoomName}
                            </h3>
                        </div>
                        <div class="card-toolbar">
                            <div class="d-flex gap-5">
                                <div class="text-end">
                                    <span class="text-gray-600 fs-7 d-block">إجمالي الطلاب</span>
                                    <span class="fw-bold text-gray-800 fs-5">${classData.totalStudents}</span>
                                </div>
                                <div class="text-end">
                                    <span class="text-gray-600 fs-7 d-block">الغائبين</span>
                                    <span class="fw-bold text-danger fs-5">${classData.absentStudents}</span>
                                </div>
                                <div class="text-end">
                                    <span class="text-gray-600 fs-7 d-block">النسبة</span>
                                    <span class="fw-bold text-danger fs-5">${classData.absencePercentage}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-row-bordered table-row-gray-100 align-middle gy-4 gs-9 mb-0">
                                <thead>
                                    <tr class="fw-bold fs-6 text-ligth border-bottom-2 border-gray-200">
                                        <th class="text-center" width="50">#</th>
                                        <th>اسم الطالبة</th>
                                        <th class="text-center" width="150">كود الطالبة</th>
                                        <th class="text-center" width="150">رقم الجوال</th>
                                        <th class="text-center" width="150">أيام الغياب المتتالية</th>
                                        <th width="200">ملاحظات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${studentsRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // Export to Excel
        function exportToExcel() {
            const date = $('#reportDate').val();
            const classId = $('#classFilter').val() || null;
            const classRoomId = $('#classRoomFilter').val() || null;

            window.location.href = `@Url.Action("ExportDailyAbsenceToExcel", "Reports")?date=${date}&classId=${classId}&classRoomId=${classRoomId}`;
        }

        // Print Official PDF Report
        function printOfficialReport() {
            const date = $('#reportDate').val();
            const classId = $('#classFilter').val() || '';
            const classRoomId = $('#classRoomFilter').val() || '';

            if (!date) {
                Swal.fire('تنبيه', 'الرجاء اختيار التاريخ', 'warning');
                return;
            }

            console.log('Starting PDF generation...', { date, classId, classRoomId });

            // Show loading
            Swal.fire({
                title: 'جاري إنشاء التقرير...',
                text: 'الرجاء الانتظار',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            // طريقة بديلة أبسط - استخدام XMLHttpRequest
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '@Url.Action("PrintDailyAbsencePdf", "Reports")', true);
            xhr.responseType = 'blob';
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

            xhr.onload = function() {
                console.log('XHR Status:', xhr.status);
                Swal.close();

                if (xhr.status === 200) {
                    // التحقق من نوع الاستجابة
                    const contentType = xhr.getResponseHeader('content-type');
                    console.log('Content-Type:', contentType);

                    if (contentType && contentType.includes('application/json')) {
                        // الاستجابة JSON (خطأ)
                        const reader = new FileReader();
                        reader.onload = function() {
                            try {
                                const error = JSON.parse(reader.result);
                                Swal.fire('خطأ', error.message || 'حدث خطأ أثناء إنشاء التقرير', 'error');
                            } catch(e) {
                                Swal.fire('خطأ', 'حدث خطأ أثناء إنشاء التقرير', 'error');
                            }
                        };
                        reader.readAsText(xhr.response);
                    } else {
                        const blob = xhr.response;
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `تقرير_الغياب_اليومي_${date}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        
                        setTimeout(() => {
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                        }, 100);

                        Swal.fire({
                            icon: 'success',
                            title: 'تم!',
                            text: 'تم إنشاء التقرير بنجاح',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    }
                } else {
                    console.error('XHR Error:', xhr.statusText);
                    Swal.fire('خطأ', 'حدث خطأ أثناء إنشاء التقرير: ' + xhr.statusText, 'error');
                }
            };

            xhr.onerror = function() {
                console.error('XHR Network Error');
                Swal.close();
                Swal.fire('خطأ', 'حدث خطأ في الاتصال بالسيرفر', 'error');
            };

            // إنشاء البيانات للإرسال
            const formData = `date=${encodeURIComponent(date)}&classId=${classId}&classRoomId=${classRoomId}`;
            console.log('Sending data:', formData);
            
            xhr.send(formData);
        }
    </script>
}
