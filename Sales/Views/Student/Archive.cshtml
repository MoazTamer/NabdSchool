@{
    ViewData["Title"] = "أرشيف الطلاب المحذوفين";
}

<div class="container-fluid">
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-danger">
                <i class="fas fa-archive"></i> أرشيف الطلاب المحذوفين
            </h6>
            <a href="@Url.Action("Index", "Student")" class="btn btn-primary btn-sm">
                <i class="fas fa-arrow-left"></i> العودة إلى قائمة الطلاب
            </a>
        </div>
        <div class="card-body">
            <!-- Filter Section -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <label>الصف:</label>
                    <select id="filterClass" class="form-control" onchange="LoadClassRooms(this.value)">
                        <option value="">الكل</option>
                        @foreach (var item in ViewBag.Classes)
                        {
                            <option value="@item.Value">@item.Text</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label>الفصل:</label>
                    <select id="filterClassRoom" class="form-control" onchange="LoadDeletedStudents()">
                        <option value="">الكل</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-primary btn-block" onclick="LoadDeletedStudents()">
                        <i class="fas fa-search"></i> بحث
                    </button>
                </div>
            </div>

            <!-- Alert -->
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>ملاحظة:</strong> هنا يتم عرض الطلاب المحذوفين. يمكنك استعادة الطالب أو حذفه نهائياً من قاعدة البيانات.
            </div>

            <!-- Deleted Students Table -->
            <div class="table-responsive">
                <table id="deletedStudentsTable" class="table table-bordered table-hover" style="width:100%">
                    <thead class="thead-dark">
                        <tr>
                            <th>رقم الطالب</th>
                            <th>اسم الطالب</th>
                            <th>رقم الجوال</th>
                            <th>الجنس</th>
                            <th>الصف</th>
                            <th>الفصل</th>
                            <th>حذف بواسطة</th>
                            <th>تاريخ الحذف</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>

    <script>
        var deletedStudentsTable;

        $(document).ready(function () {
            InitializeDataTable();
            LoadDeletedStudents();
        });

        function InitializeDataTable() {
            deletedStudentsTable = $('#deletedStudentsTable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/ar.json"
                },
                "columns": [
                    { "data": "student_Code" },
                    { "data": "student_Name" },
                    { "data": "student_Phone" },
                    {
                        "data": "student_Gender",
                        "render": function(data) {
                            return data === "ذكر" ? '<span class="badge badge-primary">ذكر</span>' :
                                   data === "أنثى" ? '<span class="badge badge-info">أنثى</span>' :
                                   '<span class="badge badge-secondary">-</span>';
                        }
                    },
                    { "data": "className" },
                    { "data": "classRoomName" },
                    {
                        "data": "deletedBy",
                        "render": function(data) {
                            return '<span class="badge badge-warning">' + data + '</span>';
                        }
                    },
                    {
                        "data": "deletedDate",
                        "render": function(data) {
                            return '<small class="text-muted">' + data + '</small>';
                        }
                    },
                    {
                        "data": null,
                        "render": function (data, type, row) {
                            return `
                                <button type="button" class="btn btn-sm btn-success" onclick="RestoreStudent(${row.student_ID}, '${row.student_Name}')" title="استعادة">
                                    <i class="fas fa-undo"></i> استعادة
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" onclick="PermanentDeleteStudent(${row.student_ID}, '${row.student_Name}')" title="حذف نهائي">
                                    <i class="fas fa-trash-alt"></i> حذف نهائي
                                </button>
                            `;
                        }
                    }
                ],
                "order": [[7, "desc"]] // ترتيب حسب تاريخ الحذف (الأحدث أولاً)
            });
        }

        function LoadDeletedStudents() {
            var classId = $('#filterClass').val();
            var classRoomId = $('#filterClassRoom').val();

            $.ajax({
                url: '@Url.Action("GetDeletedStudents", "Student")',
                type: 'GET',
                data: { classId: classId, classRoomId: classRoomId },
                success: function (response) {
                    deletedStudentsTable.clear();
                    deletedStudentsTable.rows.add(response.data);
                    deletedStudentsTable.draw();
                },
                error: function (xhr) {
                    ShowToast('error', 'خطأ في تحميل البيانات');
                }
            });
        }

        function LoadClassRooms(classId) {
            var $classRoomSelect = $('#filterClassRoom');
            $classRoomSelect.html('<option value="">الكل</option>');

            if (!classId) {
                LoadDeletedStudents();
                return;
            }

            $.ajax({
                url: '@Url.Action("GetClassRoomsByClass", "Student")',
                type: 'GET',
                data: { classId: classId },
                success: function (response) {
                    $.each(response.data, function (index, item) {
                        $classRoomSelect.append($('<option>', {
                            value: item.value,
                            text: item.text
                        }));
                    });
                    LoadDeletedStudents();
                }
            });
        }

        function RestoreStudent(id, name) {
            Swal.fire({
                title: 'تأكيد الاستعادة',
                text: `هل أنت متأكد من استعادة الطالب: ${name}؟`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'نعم، استعد',
                cancelButtonText: 'إلغاء'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("RestoreStudent", "Student")',
                        type: 'POST',
                        data: { id: id },
                        success: function (response) {
                            if (response.isValid) {
                                ShowToast('success', response.message);
                                LoadDeletedStudents();
                            } else {
                                ShowToast('error', response.message);
                            }
                        }
                    });
                }
            });
        }

        function PermanentDeleteStudent(id, name) {
            Swal.fire({
                title: 'تحذير: حذف نهائي!',
                html: `
                    <p class="text-danger"><strong>تحذير:</strong> سيتم حذف الطالب نهائياً من قاعدة البيانات!</p>
                    <p>هل أنت متأكد من حذف الطالب: <strong>${name}</strong> نهائياً؟</p>
                    <p class="text-muted"><small>لن تتمكن من استعادة البيانات بعد هذا الإجراء!</small></p>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'نعم، احذف نهائياً',
                cancelButtonText: 'إلغاء',
                input: 'checkbox',
                inputPlaceholder: 'أنا متأكد من الحذف النهائي',
                inputValidator: (result) => {
                    return !result && 'يجب تأكيد الحذف النهائي!'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("PermanentDeleteStudent", "Student")',
                        type: 'POST',
                        data: { id: id },
                        success: function (response) {
                            if (response.isValid) {
                                ShowToast('success', response.message);
                                LoadDeletedStudents();
                            } else {
                                ShowToast('error', response.message);
                            }
                        }
                    });
                }
            });
        }

        function ShowToast(type, message) {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });

            Toast.fire({
                icon: type,
                title: message
            });
        }
    </script>
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
    <style>
        .table thead.thead-dark th {
            background-color: #343a40;
            color: white;
        }

        .btn-sm {
            margin: 2px;
        }

        .alert-info {
            border-left: 4px solid #17a2b8;
        }
    </style>
}